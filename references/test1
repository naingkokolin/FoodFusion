<?php
  if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $conn = new mysqli("localhost", "root", "", "foodfusion");

    // Check connection
    if ($conn->connect_error) {
      die("Database connection failed: " . $conn->connect_error);
    }

    $showLgoinForm = false;
    $lockoutMessage = "";

    // For Sign Up
    if (isset($_POST["signUp"])) {
      $firstName = htmlspecialchars($_POST["firstName"]);
      $lastName = htmlspecialchars($_POST["lastName"]);
      $email = htmlspecialchars($_POST["email"]);
      $password = htmlspecialchars($_POST["password"]);

      $checkEmail = "SELECT * FROM user WHERE email = '$email'";
      $result = $conn->query($checkEmail);

      if ($result->num_rows > 0) {
        echo "<script>alert('This email is already registered!');</script>";
      } else {
        $hashedPassword = password_hash($password, PASSWORD_BCRYPT);
        $sql = "INSERT INTO user (firstname, lastname, email, password) VALUES ('$firstName', '$lastName', '$email', '$hashedPassword')";

        if ($conn->query($sql) === TRUE) {
          echo "<script>alert('New record created successfully');</script>";
        } else {
          echo "<script>alert('Error: " . $sql . "<br>" . $conn->error . "');</script>";
        }
      }
    }

    // For Login
    if (isset($_POST["login"])) {
      $email = htmlspecialchars($_POST["loginEmail"]);
      $password = htmlspecialchars($_POST["loginPassword"]);

      $checkAttempts = "SELECT * FROM login_attempts WHERE email = '$email'";
      $attemptsResult = $conn->query($checkAttempts);

      $query = $conn->prepare("SELECT attempts, last_attempt FROM login_attempts WHERE email = ?");
      $query->bind_param("s", $loginEmail);
      $query->execute();
      $result = $query->get_result();

      $lockoutDuration = 180;
      $currentTime = time();

      if ($attemptsResult->num_rows > 0) {
        $attemptsRow = $attemptsResult->fetch_assoc();

        if ($attemptsRow['attempts'] >= 5) {
          $lastAttemptTime = $attemptsRow['last_attempt'];
          // $remainingLockoutTime = $lockoutDuration - ($currentTime - $lastAttemptTime);
          $remainingLockoutTime = $lastAttemptTime + $lockoutDuration - $currentTime;

          if ($remainingLockoutTime > 0) {
            $lockoutMessage = "Your account is locked for " . gmdate("H:i:s", $remainingLockoutTime) . " due to too many failed login attempts.";
            $showLgoinForm = false;
          }
        }
      } else {
        $conn->query("INSERT INTO login_attempts (email, attempts) VALUES ('$email', 0)");
      }

      $sql = "SELECT * FROM user WHERE email = '$email'";
      $result = $conn->query($sql);

      if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $failAttempts = $row['fail_attempts'];
        if (password_verify($password, $row['password'])) {
          $conn->query("UPDATE login_attempts SET attempts = 0 WHERE email = '$email'");
          echo "<script>alert('Login successful');</script>";
        } else {
          $conn->query("UPDATE login_attempts SET attempts = attempts + 1 WHERE email = '$email'");
          echo "<script>alert('Incorrect password');</script>";
          $showLgoinForm = true;
        }
      } else {
        echo "<script>alert('Email not registered');</script>";
        $showLgoinForm = true;
      }
    }
    $conn->close();
  }
  ?>